#!/bin/bash
#SBATCH --partition="PGR-Standard"
#SBATCH --job-name="SSLHZH"
#SBATCH --gres=gpu:1
#SBATCH --mail-user=tianyi.li@ed.ac.uk
#SBATCH --mail-type=ALL

lrs=(0.000007961045 0.000000151822 0.000085337805 0.000000600041 0.000214818175 0.000045646762 0.000646125720 0.000022889477 0.006097331014 0.000003300558 0.000000015212 0.000000313655 0.000000011876 0.000000178728 0.000010872023 0.000011127347 0.000000012125 0.000001118687 0.000000025470 0.000000394557 0.000140086734 0.010162391807 0.000000115212 0.041102982272 0.000000010400 0.000003985982 0.000000026128 0.000000095255 0.000052702406 0.000022321402 0.008174530615 0.000296676117 0.000000068161 0.002153688652 0.000003575971 0.000000030921 0.000037843646 0.002015687620 0.000961663228 0.000000024050 0.000000126939 0.000056121678 0.004218395169 0.029261205398 0.000571468013 0.017494091651 0.006340067862 0.017758658662 0.000000118615 0.026758979941 0.000000057328 0.000028698988 0.005399867914 0.000000011709 0.000000040393 0.003450370839 0.011638774521 0.000006738311 0.000066568050 0.000000562970 0.000000021063 0.000001365592 0.000000024132 0.000033229294 0.000000413930 0.000000077443 0.000000115345 0.009313795593 0.025272295409 0.001361134579 0.009518900987 0.000914997377 0.000000033940 0.000054881174 0.003367978695 0.000333882304 0.000032493958 0.006504789661 0.000000418773 0.000005181344 0.000431697846 0.000000131292 0.009623911106 0.019932977998 0.000002677198 0.000000434572 0.000061388378 0.000000053368 0.000001106716 0.000014535954 0.000001898160 0.001078855378 0.000000442108 0.006624761455 0.006534263477 0.003362810791 0.007166493637 0.000094331754 0.000752168780 0.001248317732 0.000006431307 0.001452413699 0.000000165278 0.000000040154 0.000479724714 0.000052558432 0.000003767049 0.000055436300 0.000004637356 0.000000052105 0.000071245113 0.000000261298 0.004634232722 0.000655676741 0.000434654092 0.000057585394 0.000000145751 0.000000033106 0.000007063540 0.000160355423 0.000009785342 0.000000031482 0.000000032806 0.000621262891 0.000072332548 0.024267986836 0.008445017237 0.000027345190 0.000008242349 0.000000020461 0.000049743739 0.000000757886 0.007880560849 0.000018660953 0.000000017684 0.000000013914 0.000000031044 0.000079781233 0.000020349056 0.000005035290 0.014145475016 0.000000175468 0.000019336749 0.000031532771 0.000000036953 0.000580209350 0.000072999627 0.001496297526 0.000000849696 0.000001987330 0.000001127725 0.001693355039 0.016906069298 0.000008618719 0.017785697811 0.000246238567 0.000000050591 0.000000033821 0.002607425067 0.023176647706 0.000010909973 0.002216516153 0.000000020076 0.000017316440 0.000000675139 0.000024400356 0.001341708339 0.000028995934 0.000151281486 0.000001528446 0.000000856310 0.010866508044 0.000008350578 0.000000599507 0.004657726457 0.000035028892 0.008369415272 0.000887836252 0.001243802746 0.000004449189 0.000000178189 0.000000366511 0.000000299581 0.000006232280 0.029515890067 0.001654588894 0.000931142521 0.000072196209 0.000000012537 0.000000115429 0.000372937225 0.005867897745 0.000101198071 0.004389630892 0.000001444804 0.000861675640 0.000000417976 0.012521775040 0.006744443997 0.000001333252 0.000940962475 0.000036698025 0.000000544997 0.000991699172 0.007392730408 0.000000088651 0.000313743302 0.026639298526 0.001797557060 0.003200449909 0.000000276631 0.000000053161 0.000000744052 0.013150208769 0.000003288399 0.000000305916 0.008728357462 0.000000046586 0.000010349507 0.000000060990 0.000307230289 0.000007237398 0.046249653154 0.000032813230 0.000000030318 0.000013529256 0.000098796896 0.000000398436 0.000403953900 0.000396368985 0.000000274992 0.000037193660 0.000296894879 0.000000081315 0.005684415245 0.000001032198 0.000727391610 0.010674275705 0.000000021577 0.000002253881 0.000644872369 0.000149043443 0.003048172819 0.000205316706 0.017809337974 0.000981274589 0.000302028715 0.000003979564 0.000008299356 0.000139286834 0.007886388973 0.000718672051 0.001297718011 0.000006638496 0.000688199315 0.000004183458 0.003159411965 0.000779246985 0.022227830056 0.020747848183 0.000000113554 0.000000031930 0.000000147011 0.000261550756 0.000000130814 0.000005102420 0.000000056111 0.000000011384 0.000000046642 0.001551983482 0.015223878434 0.000021297211 0.033849332138 0.000111146756 0.013471252051 0.000000016619 0.000033495520 0.009112877688 0.019932094809 0.025562722078 0.000002851024 0.000000026961 0.000700850567 0.000000022306 0.004696050890 0.016699613681 0.000046437813 0.000096009441 0.012789174976 0.000446182008 0.019268665297 0.000556397848 0.033184163189 0.001570752073 0.000011994761 0.000085299647 0.001669565443 0.000163649560 0.004990981999 0.000007232495 0.000003178271 0.000091947294 0.003341324448 0.000001822942 0.000000047256 0.000028788410 0.007380355154 0.000001068747 0.000346304383 0.000196326693 0.000000061218 0.009886468358 0.001721238286 0.002315237245 0.009468099108 0.000000279145 0.000267792360 0.000284889889 0.000000018677 0.000005753258 0.001886547236 0.000212283091 0.000336904011 0.000001617920 0.000000043749 0.000008622005 0.004695263611 0.000000012876 0.000288339983 0.000980585946 0.000000233451 0.000000045745 0.000014185856 0.000000199405 0.000020962068 0.008012678739 0.000000243669 0.000004979275 0.000238546249 0.000000978084 0.000000272545 0.002962106138 0.000019069762 0.000181493161 0.001222319089 0.001534034998 0.003215876697 0.003499233270 0.001067740597 0.000004263278 0.001572999393 0.003204584115 0.000000126659 0.000002240912 0.000006853022 0.000000019920 0.000000898073 0.000000968027 0.007722380564 0.000055404030 0.000000268381 0.000000197197 0.003531542329 0.000000087826 0.000021148209 0.000000021393 0.000000297458 0.003941421771 0.000000128832 0.000001066290 0.008336158680 0.013664674549 0.000000010052 0.000000011660 0.000000057002 0.022463932146 0.000000709136 0.001646594762 0.000000057878 0.000576310673 0.000000094442 0.000010298128 0.000038172593 0.038120871417 0.000000510953 0.037377198240 0.001798217492 0.000092974851 0.000086633733 0.000172661269 0.000001492047 0.000000023366 0.000008032763 0.001471951825 0.000422758680 0.000000225034 0.000000081214 0.000010661758 0.010321891896 0.000006331648 0.000000489533 0.000002081119 0.000000085980 0.000012648905 0.000000173832 0.000213089427 0.000005027844 0.000000306339 0.027276277719 0.000052052944 0.000000448396 0.000000124032 0.000033870977 0.000004081418 0.016210370247 0.028054021598 0.000003990648 0.000000083192 0.030720535677 0.008900607496 0.018227756513 0.001060984200 0.000133840350 0.000234058308 0.000191672949 0.000022570836 0.000010535520 0.000000053064 0.000000388332 0.000000039853 0.000153277583 0.000000141165 0.000003659173 0.000000339805 0.000000102587 0.041447875669 0.000000014880 0.002008748219 0.000004099256 0.000067687392 0.000003283909 0.000015579822 0.001044413162 0.000000262895 0.000002997631 0.000390314061 0.000003045336 0.004032620217 0.000000116988 0.000001358557 0.001735197487 0.022171500806 0.001597634569 0.000000116411 0.000000029337 0.000013730257 0.000005157591 0.000210026274 0.000000017272 0.000126151200 0.001560850065 0.000012013901 0.026533823398 0.001986470341 0.000000276777 0.000058454955 0.000012475119 0.010428728716 0.001052583766 0.000576587673 0.000039673812 0.000035777308 0.000003018617 0.000000505837 0.000309850793 0.000037082823 0.000000098835 0.000000048727 0.005399683903 0.000045665276 0.000000131067 0.000004774456 0.000017579483 0.003320445770 0.000004250766 0.031085924557 0.000008154345 0.000000371058 0.000000122276 0.000000647737 0.000003292376 0.008033358246 0.000019575389 0.000121100948 0.000201982750 0.000187164277 0.002392544528 0.000441647019 0.000341230159 0.005233393524)
lambdas=(0.0029833056 0.0011845208 0.0011009410 0.0013337823 0.0002622264 0.0151313555 0.0020565653 0.0003742053 0.0176684642 0.0000506450 0.0004952764 0.0000164447 0.0010424718 0.0000111268 0.0000119413 0.0000137855 0.0000722245 0.0000219689 0.0000344598 0.0009777081 0.0000616531 0.0117487830 0.0000724585 0.0464960463 0.0000307470 0.0050507850 0.0020683837 0.0953248912 0.0904803306 0.0789954262 0.0248030856 0.0003243749 0.0024768562 0.0001297440 0.0017041256 0.0022720985 0.0000548865 0.0024514287 0.0204387998 0.0001054320 0.0157164337 0.0009554886 0.0021884005 0.0012980849 0.0063036541 0.0000466005 0.0053683973 0.0000141696 0.0036212118 0.0327553153 0.0000521040 0.0000718366 0.0012885174 0.0019355940 0.0003198348 0.0000186323 0.0269338075 0.0001195789 0.0003269054 0.0080182265 0.0001099275 0.0007306200 0.0426750448 0.0033858220 0.0001021636 0.0000395762 0.0000365425 0.0026599859 0.0003434726 0.0042974331 0.0053279809 0.0003118446 0.0029629568 0.0503253417 0.0013094479 0.0060062358 0.0000129056 0.0382579694 0.0577617892 0.0001490846 0.0024086568 0.0019143795 0.0014980840 0.0006966288 0.0008280350 0.0026320730 0.0031803849 0.0012465240 0.0496920350 0.0740793138 0.0000558735 0.0002544210 0.0011363549 0.0121186443 0.0000990066 0.0044144866 0.0076131915 0.0000824742 0.0008353480 0.0000965915 0.0032616749 0.0009936845 0.0007305273 0.0001710417 0.0000943676 0.0233662408 0.0003762211 0.0000849348 0.0073562312 0.0047663382 0.0101535131 0.0008152988 0.0009292432 0.0002056543 0.0778372844 0.0000227366 0.0099742694 0.0004731049 0.0014434369 0.0540248782 0.0009212613 0.0012596785 0.0365800257 0.0001016934 0.0052470819 0.0034997993 0.0001060034 0.0001727547 0.0017131321 0.0010463018 0.0003344460 0.0035692957 0.0001421719 0.0005474148 0.0223837998 0.0005436139 0.0010295537 0.0011576853 0.0685542529 0.0011514549 0.0467405777 0.0003218464 0.0001408034 0.0004729543 0.0000886837 0.0004066939 0.0797448448 0.0182526583 0.0154181782 0.0003657849 0.0009004596 0.0326852447 0.0153517928 0.0000120135 0.0001739142 0.0000673718 0.0001030080 0.0011632011 0.0293515850 0.0524028932 0.0109376749 0.0014396860 0.0339344220 0.0000596523 0.0008873162 0.0010837116 0.0051677324 0.0035203546 0.0000380436 0.0000579394 0.0006757820 0.0020081151 0.0014351227 0.0006629737 0.0003078769 0.0000804679 0.0046701551 0.0001380563 0.0006265607 0.0019117476 0.0189033413 0.0000104540 0.0000796918 0.0007049497 0.0000518308 0.0001947186 0.0128803014 0.0000420664 0.0000278587 0.0000106530 0.0186431867 0.0250872060 0.0819599577 0.0001885610 0.0000335375 0.0000796823 0.0000285816 0.0000493843 0.0007671116 0.0000699582 0.0017502904 0.0506074273 0.0006797634 0.0631823213 0.0000158890 0.0000104193 0.0003126889 0.0005989576 0.0059956608 0.0001068632 0.0002756911 0.0000129791 0.0463815807 0.0001626099 0.0029543190 0.0117604274 0.0004943566 0.0000229597 0.0001394771 0.0232393098 0.0239732809 0.0107331571 0.0534122844 0.0023400856 0.0000518560 0.0096615313 0.0008789565 0.0511349965 0.0012343135 0.0045595377 0.0073310079 0.0318161503 0.0000575043 0.0000206307 0.0447368758 0.0005245621 0.0284408622 0.0000172519 0.0673587912 0.0010649584 0.0006375152 0.0089801891 0.0006020796 0.0530028793 0.0000673656 0.0051832854 0.0042971408 0.0000175069 0.0156693989 0.0298729269 0.0001538461 0.0000113412 0.0000709751 0.0615010486 0.0007616994 0.0065114198 0.0001764045 0.0001009846 0.0075369716 0.0034311727 0.0059224702 0.0325833833 0.0032865626 0.0008746132 0.0001495654 0.0003529063 0.0005311329 0.0000271272 0.0013962724 0.0024430973 0.0000434235 0.0674651613 0.0002436681 0.0002456616 0.0000277696 0.0036821131 0.0613618566 0.0000141359 0.0953548852 0.0000452806 0.0003260699 0.0001063059 0.0057456067 0.0007899526 0.0782196635 0.0011043466 0.0023972695 0.0001462640 0.0386273141 0.0229045162 0.0001032813 0.0000110356 0.0007319469 0.0080117064 0.0596195768 0.0021158971 0.0272898959 0.0000404960 0.0000164709 0.0001279724 0.0002442349 0.0003275837 0.0000149781 0.0000744767 0.0006255484 0.0000112949 0.0005289834 0.0000503787 0.0041677613 0.0000284399 0.0000437704 0.0058710304 0.0001615280 0.0000914447 0.0000103453 0.0003532307 0.0243177176 0.0000743332 0.0013544276 0.0521182802 0.0124706119 0.0000711102 0.0000139777 0.0003004126 0.0000836981 0.0039958922 0.0000187182 0.0032107093 0.0013839974 0.0002293343 0.0337258181 0.0005124817 0.0978618686 0.0000150290 0.0016237179 0.0044574577 0.0000303508 0.0000949215 0.0001159660 0.0002469948 0.0012100992 0.0001381911 0.0007040202 0.0416850364 0.0033472478 0.0000742425 0.0060411066 0.0004074748 0.0000153605 0.0135607977 0.0004272557 0.0062802965 0.0004505536 0.0070102917 0.0002952869 0.0090699862 0.0001158147 0.0000892325 0.0299747304 0.0003071526 0.0000714759 0.0001032587 0.0030146834 0.0008170293 0.0174802943 0.0782709720 0.0170827584 0.0000936460 0.0471003088 0.0000662330 0.0751113351 0.0182912018 0.0001059033 0.0847599305 0.0020392519 0.0000305547 0.0421818186 0.0000361405 0.0031095859 0.0066351490 0.0035401769 0.0112417773 0.0007819903 0.0055856454 0.0957011391 0.0002859268 0.0037709254 0.0144347056 0.0012147693 0.0041925876 0.0073093329 0.0000122830 0.0009834118 0.0000924664 0.0043886299 0.0014142251 0.0004013426 0.0160146726 0.0076549160 0.0000109858 0.0002300038 0.0017506614 0.0015065312 0.0480177824 0.0000448439 0.0012073395 0.0011815031 0.0002021549 0.0202038482 0.0003113737 0.0001581345 0.0013023029 0.0027390344 0.0000184215 0.0000788408 0.0025536104 0.0003942249 0.0000123688 0.0160855584 0.0174560454 0.0009480144 0.0009952697 0.0087970329 0.0344792054 0.0406533695 0.0024924123 0.0046582383 0.0784618885 0.0000158118 0.0000103148 0.0000870971 0.0000198770 0.0116431208 0.0392244173 0.0001433943 0.0015509505 0.0000151250 0.0043441816 0.0156764250 0.0001152080 0.0003183321 0.0178164734 0.0663127542 0.0017255787 0.0013678656 0.0003290994 0.0000289160 0.0015975745 0.0333792602 0.0001197659 0.0244574848 0.0837028783 0.0019564844 0.0002343104 0.0934270221 0.0047783833 0.0067112514 0.0796848909 0.0004661081 0.0013983037 0.0001898157 0.0004390536 0.0129400260 0.0003021617 0.0000160465 0.0000660841 0.0009210607 0.0011951110 0.0001718883 0.0000216975 0.0000173030 0.0000380964 0.0001143855 0.0106363820 0.0001350037 0.0001333819 0.0000382862 0.0003468151 0.0001766013 0.0105818822 0.0132026995 0.0003099930 0.0010130908 0.0001564479 0.0000218523 0.0000800031 0.0000174039 0.0000156047 0.0009618637 0.0000210313 0.0651678639 0.0022552076 0.0007336023 0.0112620788 0.0048350088 0.0000334672 0.0002910119 0.0181978410 0.0788325078 0.0000218314)
# the batch_size is scaled down from 6 to 4 in order to fit roberta-large into 2080ti, correspondingly, the ``steps'' values are scaled up by floor(s*1.5).
steps=(9 24 1 12 18 16 9 24 9 16 6 13 12 12 19 6 18 4 22 15 1 6 25 15 7 21 24 18 4 10 1 13 1 6 1 13 4 1 21 6 22 3 12 16 19 19 3 21 4 3 9 21 7 6 9 4 16 4 6 19 1 22 4 6 25 22 3 12 3 4 4 1 21 25 13 21 25 16 6 7 22 19 16 1 19 4 6 9 18 25 19 9 6 16 19 3 3 9 16 16 25 3 25 22 21 25 22 15 16 18 24 25 9 9 24 1 21 18 3 12 13 1 3 13 9 3 24 24 10 12 25 7 7 24 21 13 21 22 22 13 13 24 7 7 7 24 18 21 7 15 21 4 9 25 22 22 7 3 15 22 4 13 1 18 6 10 9 25 10 13 6 13 10 21 25 22 15 4 1 13 10 4 1 7 4 24 24 19 10 15 6 21 1 16 15 4 15 13 1 21 1 1 16 7 24 24 22 13 22 25 12 6 15 7 24 10 22 1 21 22 15 6 7 22 6 19 4 19 12 12 13 24 24 24 4 7 22 4 1 7 12 10 13 19 3 3 15 15 19 22 24 22 10 3 6 15 9 1 12 25 10 4 16 10 12 12 16 13 19 18 24 18 13 25 18 19 22 19 18 1 25 10 24 12 10 7 15 15 13 24 1 7 6 1 22 25 13 13 18 6 22 7 24 22 25 13 19 1 9 15 24 18 12 6 12 22 6 7 18 3 18 18 21 7 22 13 7 15 7 19 22 21 15 13 13 16 12 19 7 6 3 19 1 6 15 22 13 3 16 15 13 19 13 12 25 15 9 3 25 3 18 18 25 18 24 24 13 25 1 4 1 10 3 19 19 12 12 22 21 9 12 19 1 9 19 12 6 10 16 9 21 10 15 25 4 1 1 9 4 18 16 4 21 16 24 25 1 9 19 19 18 7 3 12 22 6 12 16 24 21 19 10 25 13 15 21 9 16 21 18 6 9 21 16 15 10 22 12 25 19 16 21 6 13 21 3 3 12 4 22 3 3 7 25 10 10 12 12 13 4 22 19 10 3 15 12 9 18 19 21 12 7 10 3 21 25 24 7 13 24 22 12 21 19 24 6 9 12 15 12 4 18 15 3 13 21 12 25 25 16)
# steps=(6 16 1 8 12 11 6 16 6 11 4 9 8 8 13 4 12 3 15 10 1 4 17 10 5 14 16 12 3 7 1 9 1 4 1 9 3 1 14 4 15 2 8 11 13 13 2 14 3 2 6 14 5 4 6 3 11 3 4 13 1 15 3 4 17 15 2 8 2 3 3 1 14 17 9 14 17 11 4 5 15 13 11 1 13 3 4 6 12 17 13 6 4 11 13 2 2 6 11 11 17 2 17 15 14 17 15 10 11 12 16 17 6 6 16 1 14 12 2 8 9 1 2 9 6 2 16 16 7 8 17 5 5 16 14 9 14 15 15 9 9 16 5 5 5 16 12 14 5 10 14 3 6 17 15 15 5 2 10 15 3 9 1 12 4 7 6 17 7 9 4 9 7 14 17 15 10 3 1 9 7 3 1 5 3 16 16 13 7 10 4 14 1 11 10 3 10 9 1 14 1 1 11 5 16 16 15 9 15 17 8 4 10 5 16 7 15 1 14 15 10 4 5 15 4 13 3 13 8 8 9 16 16 16 3 5 15 3 1 5 8 7 9 13 2 2 10 10 13 15 16 15 7 2 4 10 6 1 8 17 7 3 11 7 8 8 11 9 13 12 16 12 9 17 12 13 15 13 12 1 17 7 16 8 7 5 10 10 9 16 1 5 4 1 15 17 9 9 12 4 15 5 16 15 17 9 13 1 6 10 16 12 8 4 8 15 4 5 12 2 12 12 14 5 15 9 5 10 5 13 15 14 10 9 9 11 8 13 5 4 2 13 1 4 10 15 9 2 11 10 9 13 9 8 17 10 6 2 17 2 12 12 17 12 16 16 9 17 1 3 1 7 2 13 13 8 8 15 14 6 8 13 1 6 13 8 4 7 11 6 14 7 10 17 3 1 1 6 3 12 11 3 14 11 16 17 1 6 13 13 12 5 2 8 15 4 8 11 16 14 13 7 17 9 10 14 6 11 14 12 4 6 14 11 10 7 15 8 17 13 11 14 4 9 14 2 2 8 3 15 2 2 5 17 7 7 8 8 9 3 15 13 7 2 10 8 6 12 13 14 8 5 7 2 14 17 16 5 9 16 15 8 14 13 16 4 6 8 10 8 3 12 10 2 9 14 8 17 17 11)

n_list=(100 100 100 100 100 100 100 100 100 100 75 75 75 75 75 75 75 75 75 75 50 50 50 50 50 50 50 50 50 50 25 25 25 25 25 25 25 25 25 25 10 10 10 10 10 10 10 10 10 10 5 5 5 5 5 5 5 5 5 5 1 1 1 1 1 1 1 1 1 1)
k_list=(10 9 8 7 6 5 4 3 2 1 10 9 8 7 6 5 4 3 2 1 10 9 8 7 6 5 4 3 2 1 10 9 8 7 6 5 4 3 2 1 10 9 8 7 6 5 4 3 2 1 10 9 8 7 6 5 4 3 2 1 10 9 8 7 6 5 4 3 2 1)
c_list=(20 20 20 20 20 20 20 20 20 20 15 15 15 15 15 15 15 15 15 15 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 5 5 5 5 5 5 5 5 5 5 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1)

exp_name=$1
data_dir=$2
data_name=$3
num_epochs=$4
hyp_id=$5

echo n-k id: "$SLURM_ARRAY_TASK_ID"
echo n: "${n_list["$SLURM_ARRAY_TASK_ID"]}"
echo k: "${k_list["$SLURM_ARRAY_TASK_ID"]}"

python src/train/train.py --model_name_or_path ../../bert_checkpoints/roberta-large --clear_cache_cycle 1 --experiment_name nk_"$SLURM_ARRAY_TASK_ID" --num_train_epochs "$num_epochs" --checkpoint_dir checkpoints_enr/"$exp_name"_"$hyp_id"/ --gradient_accumulation_steps "${steps["$hyp_id"]}" --learning_rate "${lrs["$hyp_id"]}" --train_batch_size 4 --weight_decay "${lambdas["$hyp_id"]}" --use_antipatterns --levy_holt --data_dir ../datasets/"$data_dir" --data_name "$data_name" --num_patterns "${n_list["$SLURM_ARRAY_TASK_ID"]}" --num_tokens_per_pattern "${k_list["$SLURM_ARRAY_TASK_ID"]}" --ckpts_per_epoch "${c_list["$SLURM_ARRAY_TASK_ID"]}"
